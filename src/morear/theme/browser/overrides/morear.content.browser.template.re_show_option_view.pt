<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
    xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    xmlns:v-on="http://www.vue.org/v-on"
    xmlns:v-bind="http://www.vue.org/v-bind"
    xmlns:v-model="http://www.vue.org/v-model"
    lang="en"
    metal:use-macro="context/main_template/macros/master"
    i18n:domain="plone">
<body>

<metal:content-core fill-slot="content-core">
<metal:content-core define-macro="content-core"
                    tal:define="toc context/table_of_contents|nothing;">

<?python
from plone import api
portal = api.portal.get()
prefix = '%s/++theme++moreartheme/' % portal.absolute_url()
?>



<div id="buy-photo" style="margin: 0 auto; float:initial">
<div id="product-full-image" style="float:left; width:100%">
    <div id="buy-photo-left" style="position: relative; overflow: hidden; max-width:100%">
        <img src="${context/absolute_url}/@@images/bgImage_left/large">
        <img class="lineColorImage" src="#" alt="圖層:耳機線顏色" style="display:none"/>
        <img class="shell-3d-image" src="#" alt="圖層:列印3D耳殼" style="display:none"/>
        <img class="surface-color-image-l" src="#" alt="圖層:面板顏色 左" style="display:none"/>
        <img class="logo-color-image" src="#" alt="圖層:Logo顏色" style="display:none"/>
        <img id="previewimgL" src="#" alt="圖層:客製圖案" style="display:none"/>
        <canvas id='textCanvasLeft' style="display:none"></canvas>
        <img id='textImageLeft' style="display:none">
    </div>

    <div id="buy-photo-right"
         style="position: relative; overflow: hidden; max-width:100%">
        <img src="${context/absolute_url}/@@images/bgImage_right/large">
        <img class="lineColorImage" src="#" alt="圖層:耳機線顏色" style="display:none"/>
        <img class="shell-3d-image" src="#" alt="圖層:列印3D耳殼" style="display:none"/>
        <img class="surface-color-image-r" src="#" alt="圖層:面板顏色 右" style="display:none"/>
        <img class="logo-color-image" src="#" alt="圖層:Logo顏色" style="display:none"/>
        <img id="previewimgR" src="#" alt="圖層:客製圖案" style="display:none"/>
        <canvas id='textCanvasRight' style="display:none"></canvas>
        <img id='textImageRight' style="display:none">
    </div>
</div>
<div id="share-01">
  <a target="_blank" href="https://www.facebook.com/dialog/share?app_id=215145299016013&picture=${context/absolute_url}/@@images/image&descripton=${context/description}&display=popup&href=${context/absolute_url}&redirect_uri=${context/absolute_url}/@@product_option_view">Facebook分享</a> ｜
  <a href="https://line.me/R/ti/p/HBC78wHU-6" target="_blank">Line分享</a> ｜ 
  <a href="javascript:void(0)" id="download-custom-image">儲存圖檔</a>
</div>
</div>
<!--
<div tal:content="view/parameter" style="color:#fff"></div>
-->
<script tal:condition="python:context.pType == 'earplugs'">
// 耳塞參數
var vm = new Vue({
  el: '#content',
  data: {
    message: 'Hello Vue!',

    sNumber: '${context/snPrefix}',
    productName: '${context/UID}',
    basePrice: ${context/basePrice},
    ep_material: '${python:context.ep_material[0].to_object.UID()}',
    ep_materialPrice: ${python:context.ep_material[0].to_object.price},
    ep_typeNo: '${python:context.ep_typeNo[0].to_object.UID()}',
    ep_typeNoPrice: ${python:context.ep_typeNo[0].to_object.price},
    ep_colorR: '${python:context.ep_colorR[0].to_object.UID()}',
    ep_colorRPrice: ${python:context.ep_colorR[0].to_object.price},
    ep_colorL: '${python:context.ep_colorL[0].to_object.UID()}',
    ep_colorLPrice: ${python:context.ep_colorL[0].to_object.price},
    ep_colorPrice: ${python:context.ep_colorR[0].to_object.price + context.ep_colorL[0].to_object.price},

    laserTextR: '',
    laserTextL: '',
    laserPriceR: 0,
    laserPriceL: 0,

    extSer: '',
    earplugsAmount: 1,
    totalSum: 0
  },

  methods: {
    total: function () {
        vm.totalSum = vm.earplugsAmount * ( vm.basePrice + vm.ep_materialPrice + vm.ep_typeNoPrice + vm.ep_colorRPrice + vm.ep_colorLPrice + vm.laserPriceR + vm.laserPriceL )
    }
  }

});

// 改變數量
$('#earplugs-amount').change(function() {
    vm.total();
});

// 改變材質
$('#ep_material').change(function() {
    vm.ep_materialPrice = Number($(this).find(":selected").data('price'));
    vm.ep_material = $(this).find(":selected").val();
    vm.total();
});

// 改變型號
$('#ep_typeNo').change(function() {
    vm.ep_typeNoPrice = Number($(this).find(":selected").data('price'));
    vm.ep_typeNo = $(this).find(":selected").val();
    vm.total();
});

// 改變 earplugs R 顏色
$('tr.ep_colorR td img').click(function() {
    clickItem($(this));
    vm.ep_colorRPrice = Number($(this).data('price'));
    vm.ep_colorR = $(this).data("image-uid");
    $(".ep_colorRImage").attr('src', $(this).data('image-url')).css({
                'display':'initial',
                'position': 'absolute',
                'top': '0%',
                'left': '0%',
    });
    vm.total();
});

// 改變 earplugs L 顏色
$('tr.ep_colorL td img').click(function() {
    clickItem($(this));
    vm.ep_colorLPrice = Number($(this).data('price'));
    vm.ep_colorL = $(this).data("image-uid");
    $(".ep_colorLImage").attr('src', $(this).data('image-url')).css({
                'display':'initial',
                'position': 'absolute',
                'top': '0%',
                'left': '0%',
    });
    vm.total();
});

</script>


<script tal:condition="python:context.pType == 'headphone'">
// 改變logo顏色
$(document).ready(function() {
    clickItem($(this));
    $(".logo-color-image").attr('src', '${python:api.content.find(UID=view.parameter['logoColor'])[0].getURL()}/@@images/image').css({
                'display':'initial',
                'position': 'absolute',
                'top': '0%',
                'left': '0%',
    });
});

// 改變耳機線顏色
$(document).ready(function() {
    $(".lineColorImage").attr('src', '${python:api.content.find(UID=view.parameter['lineColor'])[0].getURL()}/@@images/image').css({
                'display':'initial',
                'position': 'absolute',
                'top': '0%',
                'left': '0%',
    });
});

// 改變3D列印耳殼
$(document).ready(function() {
    $(".shell-3d-image").attr('src', '${python:api.content.find(UID=view.parameter['shell3D'])[0].getURL()}/@@images/image').css({
                'display':'initial',
                'position': 'absolute',
                'top': '0%',
                'left': '0%',
    });
});

// 改變面板顏色
$(document).ready(function() {
    $(".surface-color-image-l").attr('src', '${python:api.content.find(UID=view.parameter['surfaceL'])[0].getURL()}/@@images/image').css({
                'display':'initial',
                'position': 'absolute',
                'top': '0%',
                'left': '0%',
    });
    $(".surface-color-image-r").attr('src', '${python:api.content.find(UID=view.parameter['surfaceR'])[0].getURL()}/@@images/image').css({
                'display':'initial',
                'position': 'absolute',
                'top': '0%',
                'left': '0%',
    });
});

// 客製圖層
$(document).ready(function() {
        $( '#previewimgR' ).attr('src', "${python:view.parameter['cusImgR']}")
        $( '#previewimgR' ).css({
            'display':'initial',
            'position': 'absolute',
            'top': "${python:'%s%%' % view.parameter['upDownR']}",
            'left': "${python:'%s%%' % view.parameter['leftRightR']}",
            'transform': "${python:'rotate(%sdeg)' % (3.6*int(view.parameter['rotateR']))}",
            'width': ${python:view.parameter['zoomR']} + '%'
        });

        $( '#previewimgL' ).attr('src', "${python:view.parameter['cusImgL']}")
        $( '#previewimgL' ).css({
            'display':'initial',
            'position': 'absolute',
            'top': "${python:'%s%%' % view.parameter['upDownL']}",
            'left': "${python:'%s%%' % view.parameter['leftRightL']}",
            'transform': "${python:'rotate(%sdeg)' % (3.6*int(view.parameter['rotateL']))}",
            'width': ${python:view.parameter['zoomL']} + '%'
        });
});

// 左邊雷雕
$(document).ready(function() {
var tCtxL = document.getElementById('textCanvasLeft').getContext('2d'),
    imageElemL = document.getElementById('textImageLeft');

    tCtxL.canvas.width = 250;
    tCtxL.font = "30px Arial";
    tCtxL.fillStyle = 'red';
    tCtxL.textAlign = "center";
    tCtxL.fillText("${python:view.parameter['laserTextL']}", 160, 50);
    imageElemL.src = tCtxL.canvas.toDataURL();
//    console.log(imageElemL.src);
    $("#textImageLeft").css({
                'display':'initial',
                'position': 'absolute',
                'top': '50%',
                'left': '0%',
    });
});

// 右邊雷雕
$(document).ready(function() {
var tCtxR = document.getElementById('textCanvasRight').getContext('2d'),
    imageElemR = document.getElementById('textImageRight');

    tCtxR.canvas.width = 250;
    tCtxR.font = "30px Arial";
    tCtxR.fillStyle = 'red';
    tCtxR.textAlign = "center";
    tCtxR.fillText("${python:view.parameter['laserTextR']}", 80, 50);
    imageElemR.src = tCtxR.canvas.toDataURL();
//    console.log(imageElemR.src);
    $("#textImageRight").css({
                'display':'initial',
                'position': 'absolute',
                'top': '50%',
                'left': '0%',
    });

});

</script>








<script>
// 下載客製化圖片(通用)
$('#download-custom-image').click(function() {
    html2canvas($('#product-full-image'), {
        onrendered: function(canvas) {
            theCanvas = canvas;
            canvas.toBlob(function(blob) {
                saveAs(blob, "output.png");
            });
        }
    });
});

// 選色 (通用)
function clickItem(item) {
    $(item).attr('class', 'selected');
    $(item).siblings().removeAttr('class');
}

// 改變產品 (通用)
$('#product-uid').change(function() {
    window.location.replace($(this).find(":selected").data('url'))
});

// 輸入雷雕文字 (通用)
$('#laser-text-r').change(function() {
    textR = $(this).val();
    if(textR){
        vm.laserPriceR = 100;
    }else{
        vm.laserPriceR = 0;
    }
    vm.total();
});
$('#laser-text-l').change(function() {
    textL = $(this).val();
    if(textL){
        vm.laserPriceL = 100;
    }else{
        vm.laserPriceL = 0;
    }
    vm.total();
});



// Reload Page
$("#reload-page").click(
    function(){
        window.location.replace("${context/absolute_url}/@@product_option_view")
    }
)

// Add to cart
$("#add-to-cart").click(
    function(){
        postData = vm.$data;
        postData['action'] = 'add';
        postData['pType'] = '${context/pType}';
        $.post(
            url="${portal/absolute_url}/@@update_cart",
            data=postData
        )
          .done(function(data){
              alert( data );
              // add, delete item
              cartJsonString = $.cookie("cart")
              cartJson = jQuery.parseJSON( cartJsonString )
              itemCount = cartJson.length
              if(itemCount){
                  $('.shop-items').text(itemCount)
                  $('.shop-items').show()
              }
          })
          .fail(function() {
              alert( "加入購物車失敗，請稍候再試，或請聯絡系統管理員" );
          });
    }
)

//計算總價
$( document ).ready(function() {
    vm.total();
});

</script>


</metal:content-core>
</metal:content-core>

</body>
</html>
